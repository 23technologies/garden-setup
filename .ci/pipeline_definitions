garden-setup:
  template: 'default'
  jobs:
    head-update:
      traits:
        draft_release: ~
        version: ~
    release:
      traits:
        version:
          preprocess: 'finalize'
        release:
          nextversion: 'bump_minor'
        component_descriptor: ~
    create-update-pr:
      traits:
        version:
          preprocess: 'finalize'
        component_descriptor: ~
        update_component_deps: ~
        cronjob:
          interval: '5m'
    pull_request_integration:
      traits:
        pull-request: ~
        scheduling:
          suppress_parallel_execution: true
        version:
          preprocess:
            'inject-commit-hash'
          inject_effective_version: true
      steps:
        labels:
          image: eu.gcr.io/gardener-project/gardener/testmachinery/base-step:latest
          execute:
          - ./pr_labels.py
          - $(git config --git-dir=$SOURCE_PATH/.git --get pullrequest.id)
        testrun:
          image: eu.gcr.io/gardener-project/gardener/testmachinery/testmachinery-run:stable
          depends:
          - labels
          execute:
          - tm-test
          - --tm-chart=default
          - --landscape=test
          - --tm-landscape=external
          - --
          - --testrun-prefix=garden-setup
    integration-test:
      repo:
        trigger: false
      traits:
        scheduling:
          suppress_parallel_execution: true
        version:
          preprocess:
            'inject-commit-hash'
          inject_effective_version: true
        notifications:
          default:
            on_error:
              triggering_policy: 'only_first'
      steps:
        testrun:
          image: eu.gcr.io/gardener-project/gardener/testmachinery/testmachinery-run:stable
          execute:
          - tm-test
          - --tm-chart=default
          - --landscape=test
          - --tm-landscape=external
          - --
          - --testrun-prefix=garden-setup
