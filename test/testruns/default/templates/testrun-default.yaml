{{- $prefix := (randAlpha 5 | lower) -}}
apiVersion: testmachinery.sapcloud.io/v1beta1
kind: Testrun
metadata:
  name: {{ .Values.testrunName }}
  namespace: default
  annotations:
    purpose: full-gardener
spec:

  ttlSecondsAfterFinished: 172800 # 2 days

  locationSets:
  - name: default
    default: true
    locations:
    - type: git
      repo: https://github.com/gardener/test-infra.git
      revision: master
    - type: git
      repo: https://github.com/gardener/gardener.git
      revision: master
    - type: git
      repo: https://github.com/gardener/garden-setup.git
      revision: {{ .Values.gardensetup.version }}

  # Global config available to every test task in all phases (testFlow and onExit)
  config:
  - name: GARDENER_VERSION
    type: env
    value: {{ .Values.gardener.version }}
  - name: GARDENER_PREFIX
    type: env
    value: {{ $prefix }}
  - name: PROJECT_NAMESPACE
    type: env
    value: garden-core

  # the execution flow:
  testflow:
  - name: prepare-host
    definition:
      name: tm-scheduler-lock-gardener
      config:
      - name: HOST_CLOUDPROVIDER
        type: env
        value: {{ .Values.baseCluster }}

  - name: create-garden
    dependsOn: [ prepare-host ]
    definition:
      name: create-garden
      location: default
      config:
      {{ include "garden-config" . }}

  {{ if or (has "platform/aws" .Values.labels) (not .Values.labels) }}
  {{ include "aws-shoot" (set . "prefix" ( printf "aws-%s" $prefix ) ) }}
  - name: tests-aws
    dependsOn: [ create-shoot-aws ]
    artifactsFrom: create-shoot-aws
    definition:
      name: shootapp-test
      continueOnError: true
  - name: delete-shoot-aws
    dependsOn: [ tests-aws ]
    definition:
      name: delete-shoot
  {{ end }}

  {{ if or (has "platform/gcp" .Values.labels) (not .Values.labels) }}
  {{ include "gcp-shoot" (set . "prefix" ( printf "gcp-%s" $prefix ) ) }}
  - name: tests-gcp
    dependsOn: [ create-shoot-gcp ]
    definition:
      name: shootapp-test
      locationSet: default
      continueOnError: true
  - name: delete-shoot-gcp
    dependsOn: [ tests-gcp ]
    definition:
      name: delete-shoot
      locationSet: default
  {{ end }}

  {{ if or (has "platform/az" .Values.labels) (not .Values.labels) }}
  {{ include "az-shoot" (set . "prefix" ( printf "az-%s" $prefix ) ) }}
  - name: tests-az
    dependsOn: [ create-shoot-az ]
    definition:
      name: shootapp-test
      locationSet: default
      continueOnError: true
  - name: delete-shoot-az
    dependsOn: [ tests-az ]
    definition:
      name: delete-shoot
      locationSet: default
  {{ end }}

  - name: delete-garden
    dependsOn:
    {{ if or (has "platform/aws" .Values.labels) (not .Values.labels) }}
    - delete-shoot-aws
    {{ end }}
    {{ if or (has "platform/gcp" .Values.labels) (not .Values.labels) }}
    - delete-shoot-gcp
    {{ end}}
    {{ if or (has "platform/az" .Values.labels) (not .Values.labels) }}
    - delete-shoot-az
    {{ end}}
    definition:
      name: delete-garden
      config:
      {{ include "garden-config" . }}

  - name: reset-host
    dependsOn: [ delete-garden ]
    definition:
      name: tm-scheduler-release-gardener
      config:
      - name: CLEAN
        type: env
        value: "false"

  onExit:
  - name: clean-gardener
    useGlobalArtifacts: true
    definition:
      name: clean-gardener
      continueOnError: true
      condition: error

  - name: delete-garden
    dependsOn: [ clean-gardener ]
    useGlobalArtifacts: true
    definition:
      name: delete-garden
      continueOnError: true
      condition: error
      config:
      {{ include "garden-config" . }}

  - name: reset-host
    dependsOn: [ delete-garden ]
    useGlobalArtifacts: true
    definition:
      name: tm-scheduler-release-gardener
      condition: error
      config:
      - name: CLEAN
        type: env
        value: "true"
